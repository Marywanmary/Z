name: Core Build Workflow

on:
  workflow_call:
    inputs:
      repo_url:
        required: true
        type: string
      repo_branch:
        required: true
        type: string
      repo_short:
        required: true
        type: string
      soc_name:
        required: true
        type: string
      config_profile:
        required: true
        type: string
      ubuntu_version:
        required: false
        type: string
        default: 'ubuntu-22.04'
      manual_trigger:
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ${{ inputs.ubuntu_version }}
    outputs:
      build_success: ${{ steps.build_outcome.outputs.success }}
      kernel_version: ${{ steps.kernel_info.outputs.version }}
      devices: ${{ steps.device_info.outputs.devices }}
      artifacts_hash: ${{ steps.hash_info.outputs.hash }}

    steps:
      - name: ðŸš€ åˆå§‹åŒ–çŽ¯å¢ƒ
        uses: actions/checkout@v4
        
      - name: ðŸ’¾ è®¾ç½®ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: ðŸ“Š æ˜¾ç¤ºåˆå§‹ç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ” åˆå§‹ç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ”§ è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-distutils python3-setuptools python3-pyelftools rsync \
          unzip zlib1g-dev file wget curl ccache ecj fastjar java-propose-classpath \
          libelf-dev intltool libncurses5-dev libncursesw5-dev libssl-dev \
          python3-pyelftools subversion swig time xsltproc zlib1g-dev \
          libxml-parser-perl libgtk2.0-dev libglib2.0-dev libglade2-0-dev \
          libglade2-dev libqt5-dev python3-dev libusb-1.0-0-dev libudev-dev

      - name: ðŸ”„ è®¾ç½®ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            .ccache
            dl
            build_dir
            staging_dir
            feeds
          key: ${{ inputs.repo_short }}-${{ inputs.soc_name }}-${{ inputs.config_profile }}-${{ hashFiles('configs/**') }}
          restore-keys: |
            ${{ inputs.repo_short }}-${{ inputs.soc_name }}-${{ inputs.config_profile }}-
            ${{ inputs.repo_short }}-${{ inputs.soc_name }}-

      - name: ðŸ“¥ å…‹éš†æºç 
        run: |
          git clone ${{ inputs.repo_url }} openwrt
          cd openwrt
          git checkout ${{ inputs.repo_branch }}
          git log -1 --pretty=format:"%h - %s (%cr)"

      - name: ðŸ”€ åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          chmod +x scripts/merge_config.sh
          ./scripts/merge_config.sh ${{ inputs.repo_short }} ${{ inputs.soc_name }} ${{ inputs.config_profile }}

      - name: ðŸ” æ£€æŸ¥åŒ…ä¾èµ–
        run: |
          chmod +x scripts/check_packages.sh
          ./scripts/check_packages.sh

      - name: ðŸ› ï¸ æ‰§è¡ŒDIYè„šæœ¬
        run: |
          cd openwrt
          chmod +x ../scripts/diy.sh
          ../scripts/diy.sh ${{ inputs.repo_short }} ${{ inputs.soc_name }}

      - name: ðŸ“¦ æ›´æ–°Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ðŸŽ¯ ç”Ÿæˆæœ€ç»ˆé…ç½®
        run: |
          cd openwrt
          make defconfig
          
      - name: ðŸ” äºŒæ¬¡åŒ…æ£€æŸ¥
        run: |
          chmod +x scripts/check_packages.sh
          ./scripts/check_packages.sh final

      - name: ðŸ—ï¸ ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo -e "$(nproc) thread build"
          make -j$(nproc) || make -j1 || echo "âš ï¸ ç¼–è¯‘å¤±è´¥"
          
      - name: ðŸ“Š æ˜¾ç¤ºæœ€ç»ˆç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ” æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ“¦ æ”¶é›†ç¼–è¯‘äº§ç‰©
        run: |
          chmod +x scripts/collect_artifacts.sh
          ./scripts/collect_artifacts.sh ${{ inputs.repo_short }} ${{ inputs.soc_name }} ${{ inputs.config_profile }}

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ inputs.repo_short }}-${{ inputs.soc_name }}-${{ inputs.config_profile }}
          path: |
            artifacts/
            logs/
          retention-days: 7

      - name: ðŸ” èŽ·å–å†…æ ¸ç‰ˆæœ¬
        id: kernel_info
        run: |
          cd openwrt
          KERNEL_VER=$(make kernelconfig | grep "Kernel version" | awk '{print $3}')
          echo "version=$KERNEL_VER" >> $GITHUB_OUTPUT

      - name: ðŸ” èŽ·å–è®¾å¤‡ä¿¡æ¯
        id: device_info
        run: |
          DEVICES=$(ls artifacts/ | grep -E "factory|sysupgrade" | cut -d'-' -f2 | sort -u | tr '\n' ',')
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT

      - name: ðŸ” ç”Ÿæˆå“ˆå¸Œå€¼
        id: hash_info
        run: |
          HASH=$(sha256sum artifacts/*.bin | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: âœ… æž„å»ºç»“æžœ
        id: build_outcome
        run: |
          if [ -d "artifacts" ] && [ "$(ls -A artifacts)" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
