name: IPQ-cz

on:
  schedule:
    # åŒ—äº¬æ—¶é—´å‘¨äº”0ç‚¹ = UTCæ—¶é—´å‘¨å››16:00
    - cron: '0 16 * * 4'
  workflow_dispatch:

permissions:
  contents: write

env:
  # èŠ¯ç‰‡å˜é‡ï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰
  CHIP: ipq60xx
  
  # é»˜è®¤ä¿¡æ¯
  DEFAULT_IP: 192.168.111.1
  DEFAULT_USER: root
  DEFAULT_PASS: none
  DEFAULT_WIFI: 12345678
  AUTHOR: Mary

jobs:
  # æ„å»ºæ‰€æœ‰é…ç½®
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # é…ç½®ç±»å‹åœ¨å‰ï¼Œä»“åº“åœ¨å
        config_type: [Ultra, Max, Pro]
        repo: 
          - imm|${{ github.server_url }}/laipeng668/immortalwrt.git|master|immwrt
          - open|${{ github.server_url }}/laipeng668/openwrt.git|master|openwrt
          - lib|${{ github.server_url }}/laipeng668/openwrt-6.x.git|k6.12-nss|libwrt
      max-parallel: 3
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è°ƒè¯•ä¿¡æ¯
        run: |
          echo "=== ç¯å¢ƒä¿¡æ¯ ==="
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo "configsç›®å½•å†…å®¹:"
          ls -la configs/ || echo "configsç›®å½•ä¸å­˜åœ¨"
          
          echo "=== ç¯å¢ƒå˜é‡ ==="
          echo "CHIP: ${{ env.CHIP }}"
          echo "REPO_SHORT: ${{ env.REPO_SHORT }}"
          echo "CONFIG_TYPE: ${{ matrix.config_type }}"
          
          echo "=== é…ç½®æ–‡ä»¶å†…å®¹ ==="
          echo "èŠ¯ç‰‡åŸºç¡€é…ç½® (configs/${{ env.CHIP }}_base.config):"
          head -10 configs/${{ env.CHIP }}_base.config || echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          
          echo "ä»“åº“åŸºç¡€é…ç½® (configs/${{ env.REPO_SHORT }}_base.config):"
          head -10 configs/${{ env.REPO_SHORT }}_base.config || echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          
          echo "é…ç½®ç±»å‹æ–‡ä»¶ (configs/${{ matrix.config_type }}.config):"
          head -10 configs/${{ matrix.config_type }}.config || echo "æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          
      - name: è®¾ç½®ä»“åº“ç¯å¢ƒå˜é‡
        run: |
          set -e
          IFS='|' read -r REPO_KEY REPO_URL REPO_BRANCH REPO_SHORT <<< "${{ matrix.repo }}"
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "REPO_SHORT=${REPO_SHORT}" >> $GITHUB_ENV
          echo "CONFIG_TYPE=${{ matrix.config_type }}" >> $GITHUB_ENV
          echo "âœ… è®¾ç½®ä»“åº“ç¯å¢ƒå˜é‡å®Œæˆ: REPO_SHORT=${REPO_SHORT}, REPO_BRANCH=${REPO_BRANCH}"
          
      - name: åˆå§‹åŒ–æ—¥å¿—
        run: |
          set -e
          mkdir -p logs
          echo "=== æ„å»ºå¼€å§‹: ${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ matrix.config_type }} ===" > logs/error.log
          echo "=== ç”¨æˆ·å‹å¥½æ—¥å¿— ===" > logs/user-friendly.log
          echo "æ„å»ºå¼€å§‹: ${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ matrix.config_type }}" >> logs/user-friendly.log
          echo "âœ… æ—¥å¿—åˆå§‹åŒ–å®Œæˆ"
          
      - name: æ¸…ç†å·¥ä½œç›®å½•
        run: |
          set -e
          echo "ğŸ”„ æ­£åœ¨æ¸…ç†å·¥ä½œç›®å½•..." >> logs/user-friendly.log
          
          # å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç›¸å…³ç›®å½•
          rm -rf openwrt temp_config
          mkdir -p logs
          
          echo "âœ… å·¥ä½œç›®å½•æ¸…ç†å®Œæˆ" >> logs/user-friendly.log
          echo "âœ… å·¥ä½œç›®å½•æ¸…ç†å®Œæˆ"
          
      # ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ - æ›´å…·ä½“çš„ç¼“å­˜é”®
      - name: ç¼“å­˜feedsç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/feeds
          key: feeds-${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            feeds-${{ env.REPO_SHORT }}-${{ env.CHIP }}-
            feeds-${{ env.REPO_SHORT }}-
            feeds-
          
      - name: ç¼“å­˜ä¸‹è½½ç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            dl-${{ env.REPO_SHORT }}-${{ env.CHIP }}-
            dl-${{ env.REPO_SHORT }}-
            dl-
            
      - name: ç¼“å­˜ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ github.run_id }}
          restore-keys: |
            ccache-${{ env.REPO_SHORT }}-${{ env.CHIP }}-
            ccache-${{ env.REPO_SHORT }}-
            ccache-
            
      - name: ç¼“å­˜å·¥å…·é“¾ç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/build_dir/toolchain-*
          key: toolchain-${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            toolchain-${{ env.REPO_SHORT }}-${{ env.CHIP }}-
            toolchain-${{ env.REPO_SHORT }}-
            toolchain-
            
      - name: ç¼“å­˜stagingç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/staging_dir
          key: staging-${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            staging-${{ env.REPO_SHORT }}-${{ env.CHIP }}-
            staging-${{ env.REPO_SHORT }}-
            staging-
            
      - name: æ£€æŸ¥ç¼“å­˜çŠ¶æ€
        run: |
          echo "=== ç¼“å­˜çŠ¶æ€æ£€æŸ¥ ===" >> logs/user-friendly.log
          if [ -d "openwrt/feeds" ] && [ "$(ls -A openwrt/feeds)" ]; then
            echo "feedsç¼“å­˜: å‘½ä¸­" >> logs/user-friendly.log
            FEEDS_CACHE="âœ…"
          else
            echo "feedsç¼“å­˜: æœªå‘½ä¸­" >> logs/user-friendly.log
            FEEDS_CACHE="âŒ"
          fi
          
          if [ -d "openwrt/dl" ] && [ "$(ls -A openwrt/dl)" ]; then
            echo "dlç¼“å­˜: å‘½ä¸­" >> logs/user-friendly.log
            DL_CACHE="âœ…"
          else
            echo "dlç¼“å­˜: æœªå‘½ä¸­" >> logs/user-friendly.log
            DL_CACHE="âŒ"
          fi
          
          if [ -d "~/.ccache" ] && [ "$(ls -A ~/.ccache)" ]; then
            echo "ccacheç¼“å­˜: å‘½ä¸­" >> logs/user-friendly.log
            CCACHE_CACHE="âœ…"
          else
            echo "ccacheç¼“å­˜: æœªå‘½ä¸­" >> logs/user-friendly.log
            CCACHE_CACHE="âŒ"
          fi
          
          if [ -d "openwrt/build_dir" ] && [ "$(ls -A openwrt/build_dir)" ]; then
            echo "å·¥å…·é“¾ç¼“å­˜: å‘½ä¸­" >> logs/user-friendly.log
            TOOLCHAIN_CACHE="âœ…"
          else
            echo "å·¥å…·é“¾ç¼“å­˜: æœªå‘½ä¸­" >> logs/user-friendly.log
            TOOLCHAIN_CACHE="âŒ"
          fi
          
          if [ -d "openwrt/staging_dir" ] && [ "$(ls -A openwrt/staging_dir)" ]; then
            echo "stagingç¼“å­˜: å‘½ä¸­" >> logs/user-friendly.log
            STAGING_CACHE="âœ…"
          else
            echo "stagingç¼“å­˜: æœªå‘½ä¸­" >> logs/user-friendly.log
            STAGING_CACHE="âŒ"
          fi
          
          echo "âœ… ç¼“å­˜çŠ¶æ€æ£€æŸ¥å®Œæˆ" >> logs/user-friendly.log
          echo "ç¼“å­˜çŠ¶æ€: feeds=$FEEDS_CACHE, dl=$DL_CACHE, ccache=$CCACHE_CACHE, toolchain=$TOOLCHAIN_CACHE, staging=$STAGING_CACHE"
          
      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          set -e
          mkdir -p temp_config
          echo "ğŸ”„ åˆå¹¶é…ç½®æ–‡ä»¶..." >> logs/user-friendly.log
          echo "åˆå¹¶æ–‡ä»¶: configs/${{ env.CHIP }}_base.config" >> logs/user-friendly.log
          cat configs/${{ env.CHIP }}_base.config > temp_config/.config
          echo "åˆå¹¶æ–‡ä»¶: configs/${{ env.REPO_SHORT }}_base.config" >> logs/user-friendly.log
          cat configs/${{ env.REPO_SHORT }}_base.config >> temp_config/.config
          echo "åˆå¹¶æ–‡ä»¶: configs/${{ matrix.config_type }}.config" >> logs/user-friendly.log
          cat configs/${{ matrix.config_type }}.config >> temp_config/.config
          
          # éªŒè¯é…ç½®æ–‡ä»¶åˆå¹¶æˆåŠŸ
          if [ ! -s temp_config/.config ]; then
            echo "âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶åˆå¹¶å¤±è´¥" >> logs/user-friendly.log
            exit 1
          fi
          
          # æå–è®¾å¤‡ä¿¡æ¯ç”¨äºæ˜¾ç¤º
          DEVICE_NAMES=$(grep '^CONFIG_TARGET_DEVICE_.*=y$' temp_config/.config | sed -n 's/^CONFIG_TARGET_DEVICE_[^_]*_[^_]*_DEVICE_\([^=]*\)=y$/\1/p' | tr '\n' ' ')
          echo "âœ… é…ç½®æ–‡ä»¶åˆå¹¶æˆåŠŸï¼Œç›®æ ‡è®¾å¤‡: $DEVICE_NAMES" >> logs/user-friendly.log
          echo "âœ… é…ç½®æ–‡ä»¶åˆå¹¶æˆåŠŸï¼Œç›®æ ‡è®¾å¤‡: $DEVICE_NAMES"
          
      - name: éªŒè¯é…ç½®æ–‡ä»¶åˆå¹¶
        run: |
          set -e
          echo "ğŸ”„ éªŒè¯é…ç½®æ–‡ä»¶åˆå¹¶..." >> logs/user-friendly.log
          
          # æ£€æŸ¥åŸºç¡€é…ç½®æ–‡ä»¶
          echo "æ£€æŸ¥åŸºç¡€é…ç½®æ–‡ä»¶..." >> logs/user-friendly.log
          if [ ! -f "configs/${{ env.CHIP }}_base.config" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘èŠ¯ç‰‡åŸºç¡€é…ç½®æ–‡ä»¶: configs/${{ env.CHIP }}_base.config" >> logs/user-friendly.log
            exit 1
          fi
          
          if [ ! -f "configs/${{ env.REPO_SHORT }}_base.config" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ä»“åº“åŸºç¡€é…ç½®æ–‡ä»¶: configs/${{ env.REPO_SHORT }}_base.config" >> logs/user-friendly.log
            exit 1
          fi
          
          if [ ! -f "configs/${{ matrix.config_type }}.config" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½®ç±»å‹æ–‡ä»¶: configs/${{ matrix.config_type }}.config" >> logs/user-friendly.log
            exit 1
          fi
          
          # æ£€æŸ¥åˆå¹¶åçš„é…ç½®æ–‡ä»¶
          echo "æ£€æŸ¥åˆå¹¶åçš„é…ç½®æ–‡ä»¶..." >> logs/user-friendly.log
          if [ ! -s temp_config/.config ]; then
            echo "âŒ é”™è¯¯ï¼šåˆå¹¶åçš„é…ç½®æ–‡ä»¶ä¸ºç©º" >> logs/user-friendly.log
            exit 1
          fi
          
          # éªŒè¯å…³é”®é…ç½®é¡¹
          echo "éªŒè¯å…³é”®é…ç½®é¡¹..." >> logs/user-friendly.log
          if ! grep -q "CONFIG_TARGET_qualcommax=y" temp_config/.config; then
            echo "âŒ é”™è¯¯ï¼šåˆå¹¶åçš„é…ç½®æ–‡ä»¶ä¸­ç¼ºå°‘ç›®æ ‡æ¶æ„é…ç½®" >> logs/user-friendly.log
            exit 1
          fi
          
          if ! grep -q "CONFIG_TARGET_qualcommax_ipq60xx=y" temp_config/.config; then
            echo "âŒ é”™è¯¯ï¼šåˆå¹¶åçš„é…ç½®æ–‡ä»¶ä¸­ç¼ºå°‘ç›®æ ‡èŠ¯ç‰‡é…ç½®" >> logs/user-friendly.log
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡" >> logs/user-friendly.log
          echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
          
      - name: æå–è®¾å¤‡ä¿¡æ¯
        run: |
          set -e
          echo "ğŸ”„ æå–è®¾å¤‡ä¿¡æ¯..." >> logs/user-friendly.log
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -s temp_config/.config ]; then
            echo "âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º" >> logs/user-friendly.log
            exit 1
          fi
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºé…ç½®æ–‡ä»¶ä¸­çš„è®¾å¤‡ç›¸å…³è¡Œ
          echo "=== é…ç½®æ–‡ä»¶ä¸­çš„è®¾å¤‡ç›¸å…³è¡Œ ===" >> logs/user-friendly.log
          grep -E "CONFIG_TARGET_DEVICE" temp_config/.config >> logs/user-friendly.log
          echo "=================================" >> logs/user-friendly.log
          
          # æå–è®¾å¤‡è¡Œ - ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼
          DEVICE_LINES=$(grep '^CONFIG_TARGET_DEVICE_.*=y$' temp_config/.config)
          if [ -z "$DEVICE_LINES" ]; then
            echo "âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°å¯ç”¨çš„è®¾å¤‡" >> logs/user-friendly.log
            echo "è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦åŒ…å«ç±»ä¼¼ä»¥ä¸‹è¡Œï¼š" >> logs/user-friendly.log
            echo "CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_jdcloud_re-ss-01=y" >> logs/user-friendly.log
            exit 1
          fi
          
          # æå–è®¾å¤‡åç§°
          DEVICE_NAMES=""
          for line in $DEVICE_LINES; do
            # ä½¿ç”¨æ›´ç²¾ç¡®çš„sedè¡¨è¾¾å¼æå–è®¾å¤‡åç§°
            DEVICE_NAME=$(echo "$line" | sed -n 's/^CONFIG_TARGET_DEVICE_[^_]*_[^_]*_DEVICE_\([^=]*\)=y$/\1/p')
            if [ -n "$DEVICE_NAME" ]; then
              DEVICE_NAMES="$DEVICE_NAMES $DEVICE_NAME"
            fi
          done
          
          # éªŒè¯è®¾å¤‡åç§°
          DEVICE_COUNT=$(echo "$DEVICE_NAMES" | wc -w)
          if [ "$DEVICE_COUNT" -eq 0 ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°" >> logs/user-friendly.log
            echo "æå–åˆ°çš„è®¾å¤‡è¡Œ: $DEVICE_LINES" >> logs/user-friendly.log
            exit 1
          fi
          
          echo "DEVICE_NAMES=${DEVICE_NAMES}" >> $GITHUB_ENV
          echo "âœ… æå–åˆ°çš„è®¾å¤‡åç§°: $DEVICE_NAMES" >> logs/user-friendly.log
          echo "âœ… æå–åˆ°çš„è®¾å¤‡åç§°: $DEVICE_NAMES"
          
      - name: æ£€æŸ¥ç›®å½•çŠ¶æ€
        run: |
          set -e
          echo "ğŸ”„ æ£€æŸ¥ç›®å½•çŠ¶æ€..." >> logs/user-friendly.log
          
          if [ -d "openwrt" ]; then
            echo "openwrt ç›®å½•å­˜åœ¨ï¼Œå¤§å°: $(du -sh openwrt | cut -f1)" >> logs/user-friendly.log
            echo "openwrt ç›®å½•å†…å®¹:" >> logs/user-friendly.log
            ls -la openwrt | head -10 >> logs/user-friendly.log
          else
            echo "openwrt ç›®å½•ä¸å­˜åœ¨" >> logs/user-friendly.log
          fi
          
          if [ -d "temp_config" ]; then
            echo "temp_config ç›®å½•å­˜åœ¨ï¼Œå¤§å°: $(du -sh temp_config | cut -f1)" >> logs/user-friendly.log
          else
            echo "temp_config ç›®å½•ä¸å­˜åœ¨" >> logs/user-friendly.log
          fi
          
          echo "âœ… ç›®å½•çŠ¶æ€æ£€æŸ¥å®Œæˆ" >> logs/user-friendly.log
          echo "âœ… ç›®å½•çŠ¶æ€æ£€æŸ¥å®Œæˆ"
          
      - name: å…‹éš†æºç 
        run: |
          set -e
          echo "ğŸ”„ å‡†å¤‡å…‹éš†æºç ..." >> logs/user-friendly.log
          
          # ä½¿ç”¨ä¸´æ—¶ç›®å½•å…‹éš†ï¼Œç„¶åé‡å‘½å
          TEMP_DIR="openwrt_temp_$(date +%s)"
          
          echo "å…‹éš†æºç ä»“åº“: ${{ env.REPO_URL }} (åˆ†æ”¯: ${{ env.REPO_BRANCH }})" >> logs/user-friendly.log
          git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} "$TEMP_DIR"
          
          # å¦‚æœç›®æ ‡ç›®å½•å­˜åœ¨ï¼Œå…ˆåˆ é™¤
          if [ -d "openwrt" ]; then
            echo "åˆ é™¤ç°æœ‰çš„ openwrt ç›®å½•..." >> logs/user-friendly.log
            rm -rf openwrt
          fi
          
          # é‡å‘½åä¸´æ—¶ç›®å½•
          mv "$TEMP_DIR" openwrt
          echo "âœ… æºç å…‹éš†å®Œæˆ" >> logs/user-friendly.log
          
          # éªŒè¯å…‹éš†ç»“æœ
          if [ ! -d "openwrt" ] || [ ! -f "openwrt/Makefile" ]; then
            echo "âŒ é”™è¯¯ï¼šæºç å…‹éš†å¤±è´¥ï¼Œç›®å½•ä¸å­˜åœ¨æˆ–ä¸å®Œæ•´" >> logs/user-friendly.log
            exit 1
          fi
          
          echo "âœ… æºç éªŒè¯æˆåŠŸ" >> logs/user-friendly.log
          echo "âœ… æºç å…‹éš†æˆåŠŸ"
          
      - name: æ›´æ–°feeds
        run: |
          set -e
          cd openwrt
          echo "ğŸ”„ æ›´æ–°feeds..." >> ../logs/user-friendly.log
          
          echo "=== æ›´æ–°feedså‰ï¼Œfeedsç›®å½•å†…å®¹ ===" >> ../logs/user-friendly.log
          ls -la feeds/ >> ../logs/user-friendly.log 2>&1 || echo "feedsç›®å½•ä¸å­˜åœ¨" >> ../logs/user-friendly.log
          
          echo "æ‰§è¡Œ feeds update..." >> ../logs/user-friendly.log
          ./scripts/feeds update -a 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot)" || true
          
          echo "=== æ›´æ–°feedsåï¼Œfeedsç›®å½•å†…å®¹ ===" >> ../logs/user-friendly.log
          ls -la feeds/ >> ../logs/user-friendly.log 2>&1 || echo "feedsç›®å½•ä¸å­˜åœ¨" >> ../logs/user-friendly.log
          
          echo "æ‰§è¡Œ feeds install..." >> ../logs/user-friendly.log
          ./scripts/feeds install -a 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot)" || true
          
          echo "=== å®‰è£…feedsåï¼Œfeedsç›®å½•å†…å®¹ ===" >> ../logs/user-friendly.log
          ls -la feeds/ >> ../logs/user-friendly.log 2>&1 || echo "feedsç›®å½•ä¸å­˜åœ¨" >> ../logs/user-friendly.log
          echo "âœ… Feedsæ›´æ–°å’Œå®‰è£…å®Œæˆ" >> ../logs/user-friendly.log
          echo "âœ… Feedsæ›´æ–°å’Œå®‰è£…å®Œæˆ"
          
      - name: å®‰è£…ä¾èµ–
        run: |
          set -e
          cd openwrt
          echo "ğŸ”„ å®‰è£…ç¼–è¯‘ä¾èµ–..." >> ../logs/user-friendly.log
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils python3-setuptools rsync unzip zlib1g-dev file wget
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ" >> ../logs/user-friendly.log
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ"
          
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          set -e
          cd openwrt
          
          # åº”ç”¨é…ç½®
          cp ../temp_config/.config .config
          echo "ğŸ”„ åº”ç”¨é…ç½®..." >> ../logs/user-friendly.log
          echo "=== ç›®æ ‡è®¾å¤‡é…ç½® ===" >> ../logs/user-friendly.log
          grep -E "CONFIG_TARGET" .config >> ../logs/user-friendly.log
          echo "====================" >> ../logs/user-friendly.log
          
          # éªŒè¯é…ç½®
          echo "éªŒè¯é…ç½®..." >> ../logs/user-friendly.log
          make defconfig 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot)" || true
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ é”™è¯¯ï¼šé…ç½®éªŒè¯å¤±è´¥" >> ../logs/user-friendly.log
            exit 1
          fi
          
          # å¯ç”¨ccache
          export CCACHE_DIR=~/.ccache
          export USE_CCACHE=1
          export CCACHE_COMPRESS=1
          ccache -M 5G 2>&1 | tee -a ../logs/error.log
          
          # æ¸…ç†ä¹‹å‰çš„æ„å»ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "æ¸…ç†ä¹‹å‰çš„æ„å»º..." >> ../logs/user-friendly.log
          make clean 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot)" || true
          
          # ç¼–è¯‘
          echo "ğŸ”„ å¼€å§‹ç¼–è¯‘..." >> ../logs/user-friendly.log
          echo "ç¼–è¯‘å¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…..." >> ../logs/user-friendly.log
          
          # åˆ›å»ºè¿›åº¦æ—¥å¿—
          touch ../logs/progress.log
          echo "0" > ../logs/progress.log
          
          # åå°è¿›ç¨‹ç›‘æ§ç¼–è¯‘è¿›åº¦
          (
            while true; do
              if [ -f "openwrt/build.log" ]; then
                PROGRESS=$(grep -c "CC\|CXX\|LD\|AR\|NM" openwrt/build.log | tail -1)
                echo "$PROGRESS" > ../logs/progress.log
              fi
              sleep 10
            done
          ) &
          MONITOR_PID=$!
          
          # ç¼–è¯‘å¹¶è¿‡æ»¤è¾“å‡º - æ”¹è¿›è¿‡æ»¤è§„åˆ™ï¼Œå‡å°‘å†—ä½™ä¿¡æ¯
          make -j$(nproc) V=s 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot|make\*\*\*|No rule to make target|undefined reference to|\.c\|\.h\|\.o\|\.a\|\.so|CC|CXX|LD|AR|NM|PKG_INSTALL)" | grep -v "ERROR.*_.*" | grep -v "warning.*_.*" || true
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            kill $MONITOR_PID 2>/dev/null || true
            echo "âŒ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å•çº¿ç¨‹é‡æ–°ç¼–è¯‘..." >> ../logs/user-friendly.log
            
            # æ¸…ç†å¯èƒ½çš„æŸåæ–‡ä»¶
            echo "æ¸…ç†å¯èƒ½çš„æŸåæ–‡ä»¶..." >> ../logs/user-friendly.log
            make -j1 clean 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot)" || true
            
            echo "å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘..." >> ../logs/user-friendly.log
            make -j1 V=sc 2>&1 | tee -a ../logs/error.log | grep -E "(ERROR|FATAL|Warning:|Cannot|make\*\*\*|No rule to make target|undefined reference to|\.c\|\.h\|\.o\|\.a\|\.so|CC|CXX|LD|AR|NM|PKG_INSTALL)" | grep -v "ERROR.*_.*" | grep -v "warning.*_.*" || true
            
            if [ ${PIPESTATUS[0]} -ne 0 ]; then
              kill $MONITOR_PID 2>/dev/null || true
              echo "âŒ å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥" >> ../logs/user-friendly.log
              exit 1
            fi
          fi
          
          kill $MONITOR_PID 2>/dev/null || true
          echo "âœ… ç¼–è¯‘å®Œæˆ" >> ../logs/user-friendly.log
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          
      - name: ä¸Šä¼ è¿›åº¦æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-progress
          path: |
            logs/progress.log
          retention-days: 7
          if-no-files-found: warn
          
      - name: æ”¶é›†äº§ç‰©
        if: always()
        run: |
          set -e
          echo "ğŸ”„ æ”¶é›†äº§ç‰©..." >> logs/user-friendly.log
          ARTIFACT_DIR="${{ env.REPO_SHORT }}-${{ matrix.config_type }}"
          FIRMWARE_DIR="${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware"
          mkdir -p "$ARTIFACT_DIR"
          mkdir -p "$FIRMWARE_DIR"
          
          TARGET_DIR="openwrt/bin/targets/qualcommax/${{ env.CHIP }}"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp temp_config/.config "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.config"
          
          # å¤åˆ¶å…¶ä»–æ–‡ä»¶
          if [ -f "openwrt/.config.buildinfo" ]; then
            cp openwrt/.config.buildinfo "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.config.buildinfo"
          fi
          
          if [ -d "$TARGET_DIR" ] && [ -f "$TARGET_DIR"/*.manifest ]; then
            cp "$TARGET_DIR"/*.manifest "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.manifest"
          fi
          
          if [ -f "openwrt/build.log" ]; then
            cp openwrt/build.log "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}-build.log"
          fi
          
          if [ -d "openwrt/bin/packages" ]; then
            mkdir -p "$ARTIFACT_DIR/packages"
            cp -r openwrt/bin/packages/* "$ARTIFACT_DIR/packages/"
          fi
          
          if [ -f "logs/error.log" ] && [ -s "logs/error.log" ]; then
            cp logs/error.log "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}-error.log"
          fi
          
          if [ -f "logs/user-friendly.log" ] && [ -s "logs/user-friendly.log" ]; then
            cp logs/user-friendly.log "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}-user-friendly.log"
          fi
          
          # å¤„ç†å›ºä»¶æ–‡ä»¶
          if [ -d "$TARGET_DIR" ]; then
            FIRMWARE_COUNT=0
            for file in "$TARGET_DIR"/*.bin; do
              if [ -f "$file" ] && [[ "$file" == *"-squashfs-"* ]]; then
                DEVICE_NAME_FROM_FILE=$(basename "$file" | sed -n 's/^.*-\(.*\)-squashfs-.*\.bin$/\1/p')
                
                if [ -z "$DEVICE_NAME_FROM_FILE" ]; then
                  echo "è­¦å‘Šï¼šæ— æ³•ä»æ–‡ä»¶åä¸­æå–è®¾å¤‡åç§°: $(basename "$file")" >> logs/user-friendly.log
                  continue
                fi
                
                if [[ "$file" == *"factory"* ]]; then
                  FIRMWARE_TYPE="factory"
                elif [[ "$file" == *"sysupgrade"* ]]; then
                  FIRMWARE_TYPE="sysupgrade"
                else
                  continue
                fi
                
                NEW_NAME="${{ env.REPO_SHORT }}-${DEVICE_NAME_FROM_FILE}-${FIRMWARE_TYPE}-${{ matrix.config_type }}.bin"
                cp "$file" "$FIRMWARE_DIR/$NEW_NAME"
                echo "å¤„ç†å›ºä»¶: $(basename "$file") -> $NEW_NAME" >> logs/user-friendly.log
                FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
              fi
            done
            echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼Œå…±å¤„ç† $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶" >> logs/user-friendly.log
            echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼Œå…±å¤„ç† $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
          else
            echo "âŒ è­¦å‘Šï¼šç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR" >> logs/user-friendly.log
            echo "âŒ è­¦å‘Šï¼šç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR"
          fi
          
      - name: ä¸Šä¼ äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}
          path: |
            ${{ env.REPO_SHORT }}-${{ matrix.config_type }}/
          retention-days: 7
          if-no-files-found: error
          
      - name: ä¸Šä¼ å›ºä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware
          path: |
            ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware/
          retention-days: 7
          if-no-files-found: error

  # æ‰“åŒ…å¹¶å‘å¸ƒRelease
  package-and-release:
    needs: build
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/
          
      - name: å‡†å¤‡å‘å¸ƒç›®å½•
        run: |
          set -e
          echo "ğŸ”„ å‡†å¤‡å‘å¸ƒç›®å½•..."
          mkdir -p release/{config,log,app,firmware,assets}
          
          # æ”¶é›†é…ç½®æ–‡ä»¶
          echo "æ”¶é›†é…ç½®æ–‡ä»¶..."
          find all-artifacts -name "*.config" -exec cp {} release/config/ \;
          find all-artifacts -name "*.config.buildinfo" -exec cp {} release/config/ \;
          find all-artifacts -name "*.manifest" -exec cp {} release/config/ \;
          
          # æ”¶é›†æ—¥å¿—æ–‡ä»¶
          echo "æ”¶é›†æ—¥å¿—æ–‡ä»¶..."
          find all-artifacts -name "*-build.log" -exec cp {} release/log/ \;
          find all-artifacts -name "*-error.log" -exec cp {} release/log/ \;
          find all-artifacts -name "*-user-friendly.log" -exec cp {} release/log/ \;
          
          # æ”¶é›†è½¯ä»¶åŒ…
          echo "æ”¶é›†è½¯ä»¶åŒ…..."
          find all-artifacts -name "packages" -type d -exec cp -r {} release/app/ \;
          
          # æ”¶é›†å›ºä»¶æ–‡ä»¶
          echo "æ”¶é›†å›ºä»¶æ–‡ä»¶..."
          find all-artifacts -name "*.bin" -exec cp {} release/firmware/ \;
          
          # æ‰“åŒ…æ–‡ä»¶
          echo "æ‰“åŒ…æ–‡ä»¶..."
          tar -czf release/${{ env.CHIP }}-config.tar.gz -C release/config .
          tar -czf release/${{ env.CHIP }}-log.tar.gz -C release/log .
          tar -czf release/${{ env.CHIP }}-app.tar.gz -C release/app .
          
          # å¤åˆ¶åˆ°assetsç›®å½•
          cp release/${{ env.CHIP }}-config.tar.gz release/assets/
          cp release/${{ env.CHIP }}-log.tar.gz release/assets/
          cp release/${{ env.CHIP }}-app.tar.gz release/assets/
          cp release/firmware/*.bin release/assets/ 2>/dev/null || true
          
          # æå–ä¿¡æ¯
          KERNEL_VERSION=""
          LUCI_APPS=""
          DEVICE_LIST=""
          BUILD_STATUS="æˆåŠŸ"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—
          if find release/log -name "*-error.log" -exec grep -l "é”™è¯¯" {} \; | grep -q .; then
            BUILD_STATUS="éƒ¨åˆ†å¤±è´¥"
          fi
          
          for config_file in release/config/*.config; do
            KERNEL_VER=$(grep "^CONFIG_LINUX_KERNEL_VERSION=" "$config_file" | cut -d'"' -f2)
            if [ -n "$KERNEL_VER" ]; then
              KERNEL_VERSION="$KERNEL_VER"
              break
            fi
          done
          
          if [ -d release/app ]; then
            LUCI_APPS=$(find release/app -name "luci-app-*.ipk" | sed 's/.*\///g' | sort | uniq | tr '\n' ' ')
          fi
          
          if [ -d release/firmware ]; then
            DEVICE_LIST=$(ls release/firmware/*.bin | sed -n 's/.*-\([^-]*\)-.*\.bin/\1/p' | sort | uniq | tr '\n' ' ')
          fi
          
          echo "KERNEL_VERSION=${KERNEL_VERSION}" >> $GITHUB_ENV
          echo "LUCI_APPS=${LUCI_APPS}" >> $GITHUB_ENV
          echo "DEVICE_LIST=${DEVICE_LIST}" >> $GITHUB_ENV
          echo "BUILD_STATUS=${BUILD_STATUS}" >> $GITHUB_ENV
          echo "RELEASE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          
          # åˆ›å»ºç”¨æˆ·å‹å¥½çš„Release body
          cat > release/body.md << EOF
          # ${{ env.CHIP }} å›ºä»¶å‘å¸ƒ (${{ env.RELEASE_DATE }})
          
          ## æ„å»ºçŠ¶æ€: ${{ env.BUILD_STATUS }}
          
          ### é»˜è®¤ä¿¡æ¯
          - ç®¡ç†åœ°å€: ${{ env.DEFAULT_IP }}
          - ç”¨æˆ·å: ${{ env.DEFAULT_USER }}
          - å¯†ç : ${{ env.DEFAULT_PASS }}
          - WiFiå¯†ç : ${{ env.DEFAULT_WIFI }}
          
          ### è®¾å¤‡ä¿¡æ¯
          - æ”¯æŒçš„è®¾å¤‡: ${{ env.DEVICE_LIST }}
          - å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          
          ### é¢„è£…åº”ç”¨
          ${{ env.LUCI_APPS }}
          
          ## ä¸‹è½½è¯´æ˜
          1. **å›ºä»¶æ–‡ä»¶**: ç›´æ¥ä¸‹è½½å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶ï¼ˆ.binï¼‰
          2. **é…ç½®æ–‡ä»¶**: ä¸‹è½½ \`${{ env.CHIP }}-config.tar.gz\` æŸ¥çœ‹ç¼–è¯‘é…ç½®
          3. **ç¼–è¯‘æ—¥å¿—**: ä¸‹è½½ \`${{ env.CHIP }}-log.tar.gz\` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
          4. **è½¯ä»¶åŒ…**: ä¸‹è½½ \`${{ env.CHIP }}-app.tar.gz\` è·å–é¢„è£…è½¯ä»¶åŒ…
          
          ## æ³¨æ„äº‹é¡¹
          - åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          - é¦–æ¬¡åˆ·æœºå»ºè®®ä½¿ç”¨TFTPæ–¹å¼
          - åˆ·æœºåæ¢å¤å‡ºå‚è®¾ç½®
          
          ---
          ä½œè€…: ${{ env.AUTHOR }}
          å‘å¸ƒæ—¶é—´: ${{ env.RELEASE_DATE }}
          EOF
          echo "âœ… å‘å¸ƒç›®å½•å‡†å¤‡å®Œæˆ"
          echo "âœ… å‘å¸ƒç›®å½•å‡†å¤‡å®Œæˆ"
          
      - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v1
        if: always()
        with:
          tag_name: ${{ env.RELEASE_DATE }}-${{ env.CHIP }}
          name: ${{ env.CHIP }} Release ${{ env.RELEASE_DATE }}
          body_path: release/body.md
          files: |
            release/assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
