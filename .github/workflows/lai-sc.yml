name: IPQ-LAI-scè„šæœ¬

on:
  schedule:
    # åŒ—äº¬æ—¶é—´å‘¨äº”0ç‚¹ = UTCæ—¶é—´å‘¨å››16:00
    - cron: '0 16 * * 4'
  workflow_dispatch:

permissions:
  contents: write

env:
  # èŠ¯ç‰‡å˜é‡ï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰
  CHIP: ipq60xx
  
  # é»˜è®¤ä¿¡æ¯
  DEFAULT_IP: 192.168.111.1
  DEFAULT_USER: root
  DEFAULT_PASS: none
  DEFAULT_WIFI: 12345678
  AUTHOR: Mary

jobs:
  # æ„å»ºæ‰€æœ‰é…ç½®
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # é…ç½®ç±»å‹åœ¨å‰ï¼Œä»“åº“åœ¨å
        config_type: [Ultra, Max, Pro]
        repo: 
          - imm|${{ github.server_url }}/laipeng668/immortalwrt.git|master|immwrt
          - open|${{ github.server_url }}/laipeng668/openwrt.git|master|openwrt
          - lib|${{ github.server_url }}/laipeng668/openwrt-6.x.git|k6.12-nss|libwrt
      max-parallel: 3
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®ä»“åº“ç¯å¢ƒå˜é‡
        run: |
          set -e
          echo "ğŸ”„ è®¾ç½®ä»“åº“ç¯å¢ƒå˜é‡..."
          IFS='|' read -r REPO_KEY REPO_URL REPO_BRANCH REPO_SHORT <<< "${{ matrix.repo }}"
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "REPO_SHORT=${REPO_SHORT}" >> $GITHUB_ENV
          echo "CONFIG_TYPE=${{ matrix.config_type }}" >> $GITHUB_ENV
          echo "âœ… ä»“åº“ç¯å¢ƒå˜é‡è®¾ç½®æˆåŠŸ"
          echo "   - ä»“åº“: ${REPO_URL}"
          echo "   - åˆ†æ”¯: ${REPO_BRANCH}"
          echo "   - ç®€ç§°: ${REPO_SHORT}"
          echo "   - é…ç½®: ${{ matrix.config_type }}"
          
      - name: åˆå§‹åŒ–æ—¥å¿—
        run: |
          set -e
          echo "ğŸ”„ åˆå§‹åŒ–æ—¥å¿—..."
          mkdir -p logs
          echo "æ„å»ºå¼€å§‹: ${{ env.REPO_SHORT }}-${{ env.CHIP }}-${{ matrix.config_type }}" > logs/error.log
          echo "æ„å»ºæ—¶é—´: $(date)" >> logs/error.log
          echo "âœ… æ—¥å¿—åˆå§‹åŒ–æˆåŠŸ"
          
      - name: æ¸…ç†å·¥ä½œç›®å½•
        run: |
          set -e
          echo "ğŸ”„ æ¸…ç†å·¥ä½œç›®å½•..."
          echo "æ¸…ç†å·¥ä½œç›®å½•..." >> logs/error.log
          rm -rf openwrt temp_config
          echo "å·¥ä½œç›®å½•æ¸…ç†å®Œæˆ" >> logs/error.log
          echo "âœ… å·¥ä½œç›®å½•æ¸…ç†æˆåŠŸ"
          
      # ç¼“å­˜ç­–ç•¥
      - name: ç¼“å­˜feedsç›®å½•
        id: cache-feeds
        uses: actions/cache@v4
        with:
          path: openwrt/feeds
          key: feeds-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            feeds-
          
      - name: ç¼“å­˜ä¸‹è½½ç›®å½•
        id: cache-dl
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            dl-
            
      - name: ç¼“å­˜ccache
        id: cache-ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ github.run_id }}
          restore-keys: |
            ccache-
            
      - name: ç¼“å­˜å·¥å…·é“¾ç›®å½•
        id: cache-toolchain
        uses: actions/cache@v4
        with:
          path: openwrt/build_dir/toolchain-*
          key: toolchain-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            toolchain-
            
      - name: ç¼“å­˜stagingç›®å½•
        id: cache-staging
        uses: actions/cache@v4
        with:
          path: openwrt/staging_dir
          key: staging-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            staging-
          
      - name: æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
        run: |
          echo "ğŸ”„ æ£€æŸ¥ç¼“å­˜çŠ¶æ€..."
          echo "ç¼“å­˜çŠ¶æ€:"
          echo "- feeds: ${{ steps.cache-feeds.outputs.cache-hit }}"
          echo "- dl: ${{ steps.cache-dl.outputs.cache-hit }}"
          echo "- ccache: ${{ steps.cache-ccache.outputs.cache-hit }}"
          echo "- toolchain: ${{ steps.cache-toolchain.outputs.cache-hit }}"
          echo "- staging: ${{ steps.cache-staging.outputs.cache-hit }}"
          echo "âœ… ç¼“å­˜çŠ¶æ€æ£€æŸ¥å®Œæˆ"
          
      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          set -e
          echo "ğŸ”„ åˆå¹¶é…ç½®æ–‡ä»¶..."
          mkdir -p temp_config
          cat configs/${{ env.CHIP }}_base.config > temp_config/.config
          cat configs/${{ env.REPO_SHORT }}_base.config >> temp_config/.config
          cat configs/${{ matrix.config_type }}.config >> temp_config/.config
          
          if [ ! -s temp_config/.config ]; then
            echo "âŒ é…ç½®æ–‡ä»¶åˆå¹¶å¤±è´¥"
            echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶åˆå¹¶å¤±è´¥" >> logs/error.log
            exit 1
          fi
          
          # æå–è®¾å¤‡ä¿¡æ¯ç”¨äºæ˜¾ç¤º
          DEVICE_LINES=$(grep '^CONFIG_TARGET_DEVICE_.*=y$' temp_config/.config)
          DEVICE_NAMES=""
          for line in $DEVICE_LINES; do
            DEVICE_NAME=$(echo "$line" | sed -n 's/^CONFIG_TARGET_DEVICE_[^_]*_[^_]*_DEVICE_\([^=]*\)=y/\1/p')
            if [ -n "$DEVICE_NAME" ]; then
              DEVICE_NAMES="$DEVICE_NAMES $DEVICE_NAME"
            fi
          done
          
          echo "âœ… é…ç½®æ–‡ä»¶åˆå¹¶æˆåŠŸï¼Œç›®æ ‡è®¾å¤‡: $DEVICE_NAMES"
          
      - name: æå–è®¾å¤‡ä¿¡æ¯
        run: |
          set -e
          echo "ğŸ”„ æå–è®¾å¤‡ä¿¡æ¯..."
          DEVICE_LINES=$(grep '^CONFIG_TARGET_DEVICE_.*=y$' temp_config/.config)
          if [ -z "$DEVICE_LINES" ]; then
            echo "âŒ é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°å¯ç”¨çš„è®¾å¤‡"
            echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°å¯ç”¨çš„è®¾å¤‡" >> logs/error.log
            exit 1
          fi
          
          DEVICE_NAMES=""
          for line in $DEVICE_LINES; do
            DEVICE_NAME=$(echo "$line" | sed -n 's/^CONFIG_TARGET_DEVICE_[^_]*_[^_]*_DEVICE_\([^=]*\)=y/\1/p')
            if [ -n "$DEVICE_NAME" ]; then
              DEVICE_NAMES="$DEVICE_NAMES $DEVICE_NAME"
            fi
          done
          
          DEVICE_COUNT=$(echo "$DEVICE_NAMES" | wc -w)
          if [ "$DEVICE_COUNT" -eq 0 ]; then
            echo "âŒ æ— æ³•ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°"
            echo "é”™è¯¯ï¼šæ— æ³•ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°" >> logs/error.log
            exit 1
          fi
          
          echo "DEVICE_NAMES=${DEVICE_NAMES}" >> $GITHUB_ENV
          echo "è®¾å¤‡æ•°é‡: $DEVICE_COUNT" >> logs/error.log
          echo "âœ… è®¾å¤‡ä¿¡æ¯æå–æˆåŠŸï¼Œæ‰¾åˆ° $DEVICE_COUNT ä¸ªè®¾å¤‡: $DEVICE_NAMES"
          
      - name: æ£€æŸ¥ç³»ç»Ÿä¾èµ–
        run: |
          set -e
          echo "ğŸ”„ æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
          echo "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..." >> logs/error.log
          dpkg -l | grep -E "build-essential|clang|flex|bison|g\+\+|gawk|gcc-multilib|g\+\+-multilib|gettext|git|libncurses5-dev|libssl-dev|python3-distutils|python3-setuptools|rsync|unzip|zlib1g-dev|file|wget" >> logs/error.log
          which gcc g++ make git python3 >> logs/error.log
          echo "âœ… ç³»ç»Ÿä¾èµ–æ£€æŸ¥å®Œæˆ"
          
      - name: å…‹éš†æºç 
        run: |
          set -e
          echo "ğŸ”„ å…‹éš†æºç ..."
          echo "å…‹éš†æºç ..." >> logs/error.log
          
          # å¼ºåˆ¶åˆ é™¤å¯èƒ½å­˜åœ¨çš„openwrtç›®å½•
          if [ -d "openwrt" ]; then
            echo "å‘ç°å·²å­˜åœ¨çš„openwrtç›®å½•ï¼Œæ­£åœ¨åˆ é™¤..." >> logs/error.log
            rm -rf openwrt
            echo "openwrtç›®å½•å·²åˆ é™¤" >> logs/error.log
          fi
          
          # ç¡®ä¿ç›®å½•å·²åˆ é™¤
          if [ -d "openwrt" ]; then
            echo "âŒ æ— æ³•åˆ é™¤openwrtç›®å½•"
            echo "é”™è¯¯ï¼šæ— æ³•åˆ é™¤openwrtç›®å½•" >> logs/error.log
            exit 1
          fi
          
          # å…‹éš†æºç 
          echo "å¼€å§‹å…‹éš†ä»“åº“: ${{ env.REPO_URL }}" >> logs/error.log
          git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
          
          # éªŒè¯å…‹éš†æ˜¯å¦æˆåŠŸ
          if [ ! -d "openwrt" ]; then
            echo "âŒ æºç å…‹éš†å¤±è´¥"
            echo "é”™è¯¯ï¼šæºç å…‹éš†å¤±è´¥" >> logs/error.log
            exit 1
          fi
          
          echo "æºç å…‹éš†æˆåŠŸ" >> logs/error.log
          echo "âœ… æºç å…‹éš†æˆåŠŸ"
          
      - name: å®‰è£…ä¾èµ–
        run: |
          set -e
          echo "ğŸ”„ å®‰è£…ä¾èµ–..."
          cd openwrt
          echo "å®‰è£…ä¾èµ–..." >> ../logs/error.log
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils python3-setuptools rsync unzip zlib1g-dev file wget
          echo "âœ… ä¾èµ–å®‰è£…æˆåŠŸ"
          
      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        run: |
          set -e
          echo "ğŸ”„ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          cd openwrt
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..." >> ../logs/error.log
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "../scripts/script.sh" ]; then
            echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: ../scripts/script.sh"
            echo "é”™è¯¯ï¼šè„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: ../scripts/script.sh" >> ../logs/error.log
            exit 1
          fi
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x ../scripts/script.sh
          
          # æ‰§è¡Œè„šæœ¬ï¼ŒåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ—¥å¿—æ–‡ä»¶
          echo "å¼€å§‹æ‰§è¡Œè„šæœ¬..." >> ../logs/error.log
          if ! ../scripts/script.sh 2>&1 | tee -a ../logs/error.log; then
            echo "âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "é”™è¯¯ï¼šè‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥" >> ../logs/error.log
            exit 1
          fi
          
          echo "è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ" >> ../logs/error.log
          echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          set -e
          echo "ğŸ”„ ç¼–è¯‘å›ºä»¶..."
          cd openwrt
          
          # åº”ç”¨é…ç½®
          cp ../temp_config/.config .config
          
          # æ·»åŠ ç¼ºå¤±çš„å†…æ ¸é…ç½®é€‰é¡¹
          echo "# CONFIG_NF_CONNTRACK_DSCPREMARK_EXT is not set" >> .config
          
          # éªŒè¯é…ç½®æ–‡ä»¶
          echo "éªŒè¯é…ç½®æ–‡ä»¶..." >> ../logs/error.log
          grep -E "CONFIG_TARGET_DEVICE_|CONFIG_LINUX_KERNEL_VERSION|CONFIG_NF_CONNTRACK_DSCPREMARK_EXT" .config >> ../logs/error.log
          
          echo "è¿è¡Œdefconfig..." >> ../logs/error.log
          make defconfig >> ../logs/error.log 2>&1
          
          # å†æ¬¡ç¡®è®¤æ–°é€‰é¡¹è¢«ç¦ç”¨
          echo "# CONFIG_NF_CONNTRACK_DSCPREMARK_EXT is not set" >> .config
          
          # å¯ç”¨ccache
          export CCACHE_DIR=~/.ccache
          export USE_CCACHE=1
          export CCACHE_COMPRESS=1
          
          # ç¼–è¯‘ - å‡å°‘è¾“å‡ºä½†ä¿ç•™è¿›åº¦ä¿¡æ¯
          echo "å¼€å§‹ç¼–è¯‘..." >> ../logs/error.log
          echo "ä½¿ç”¨ $(nproc) ä¸ªå¹¶è¡Œä»»åŠ¡è¿›è¡Œç¼–è¯‘" >> ../logs/error.log
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶è®°å½•ç¼–è¯‘è¾“å‡º
          COMPILE_LOG=$(mktemp)
          PROGRESS_LOG=$(mktemp)
          
          # æ˜¾ç¤ºç¼–è¯‘è¿›åº¦
          echo "ç¼–è¯‘è¿›åº¦:" > "$PROGRESS_LOG"
          
          # åå°è¿›ç¨‹ç›‘æ§ç¼–è¯‘è¿›åº¦
          (
            while true; do
              if [ -f "$COMPILE_LOG" ]; then
                echo "$(date): ç¼–è¯‘è¿›è¡Œä¸­..." >> "$PROGRESS_LOG"
                # æŸ¥æ‰¾å…³é”®è¿›åº¦ä¿¡æ¯
                grep -a "CC\|LD\|AR\|GEN" "$COMPILE_LOG" | tail -5 >> "$PROGRESS_LOG" 2>/dev/null || true
              fi
              sleep 30
            done
          ) &
          PROGRESS_PID=$!
          
          # å°è¯•ç¼–è¯‘ï¼Œæ•è·é”™è¯¯
          if ! make -j$(nproc) V=s 2>&1 | tee "$COMPILE_LOG"; then
            echo "âŒ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å•çº¿ç¨‹é‡æ–°ç¼–è¯‘..."
            echo "é”™è¯¯ï¼šå¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å•çº¿ç¨‹é‡æ–°ç¼–è¯‘..." >> ../logs/error.log
            
            # è®°å½•æœ€å1000è¡Œç¼–è¯‘è¾“å‡º
            echo "=== æœ€å1000è¡Œç¼–è¯‘è¾“å‡º ===" >> ../logs/error.log
            tail -n 1000 "$COMPILE_LOG" >> ../logs/error.log
            
            # å°è¯•å•çº¿ç¨‹ç¼–è¯‘
            if ! make -j1 V=sc 2>&1 | tee "$COMPILE_LOG"; then
              echo "âŒ å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥"
              echo "é”™è¯¯ï¼šå•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥" >> ../logs/error.log
              
              # è®°å½•æœ€å2000è¡Œç¼–è¯‘è¾“å‡º
              echo "=== æœ€å2000è¡Œç¼–è¯‘è¾“å‡º ===" >> ../logs/error.log
              tail -n 2000 "$COMPILE_LOG" >> ../logs/error.log
              
              # æŸ¥æ‰¾å…³é”®é”™è¯¯ä¿¡æ¯
              echo "=== å…³é”®é”™è¯¯ä¿¡æ¯ ===" >> ../logs/error.log
              grep -i -A 5 -B 5 "error\|Error\|ERROR\|failed\|Failed\|FAILED" "$COMPILE_LOG" | head -50 >> ../logs/error.log
              
              kill $PROGRESS_PID 2>/dev/null || true
              rm -f "$COMPILE_LOG" "$PROGRESS_LOG"
              
              # è®¾ç½®ç¼–è¯‘å¤±è´¥æ ‡å¿—
              echo "COMPILE_FAILED=true" >> $GITHUB_ENV
              exit 1
            fi
          fi
          
          # åœæ­¢è¿›åº¦ç›‘æ§
          kill $PROGRESS_PID 2>/dev/null || true
          
          # è®°å½•ç¼–è¯‘è¿›åº¦æ—¥å¿—
          echo "=== ç¼–è¯‘è¿›åº¦æ—¥å¿— ===" >> ../logs/error.log
          cat "$PROGRESS_LOG" >> ../logs/error.log
          
          rm -f "$COMPILE_LOG" "$PROGRESS_LOG"
          echo "ç¼–è¯‘å®Œæˆ" >> ../logs/error.log
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          
      - name: ç”Ÿæˆç¼–è¯‘æ‘˜è¦
        if: always()
        run: |
          set -e
          echo "ğŸ”„ ç”Ÿæˆç¼–è¯‘æ‘˜è¦..."
          echo "=== ç¼–è¯‘æ‘˜è¦ ===" > logs/summary.log
          
          # è®°å½•åŸºæœ¬ä¿¡æ¯
          echo "ä»“åº“: ${{ env.REPO_SHORT }}" >> logs/summary.log
          echo "é…ç½®: ${{ matrix.config_type }}" >> logs/summary.log
          echo "èŠ¯ç‰‡: ${{ env.CHIP }}" >> logs/summary.log
          echo "å¼€å§‹æ—¶é—´: $(date)" >> logs/summary.log
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          TARGET_DIR="openwrt/bin/targets/${{ env.CHIP }}"
          if [ -d "$TARGET_DIR" ] && [ -f "$TARGET_DIR/"*.bin ]; then
            echo "ç¼–è¯‘çŠ¶æ€: æˆåŠŸ" >> logs/summary.log
            echo "ç”Ÿæˆçš„å›ºä»¶:" >> logs/summary.log
            ls -la "$TARGET_DIR"/*.bin | grep squashfs >> logs/summary.log
            echo "âœ… ç¼–è¯‘æ‘˜è¦ç”ŸæˆæˆåŠŸï¼Œç¼–è¯‘çŠ¶æ€: æˆåŠŸ"
          else
            echo "ç¼–è¯‘çŠ¶æ€: å¤±è´¥" >> logs/summary.log
            echo "è¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—äº†è§£è¯¦æƒ…" >> logs/summary.log
            echo "âœ… ç¼–è¯‘æ‘˜è¦ç”ŸæˆæˆåŠŸï¼Œç¼–è¯‘çŠ¶æ€: å¤±è´¥"
          fi
          
          echo "ç»“æŸæ—¶é—´: $(date)" >> logs/summary.log
          echo "=== ç¼–è¯‘æ‘˜è¦ ===" >> logs/summary.log
          
          # å¦‚æœç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºå·¥ä½œæµ
          if [ "${{ env.COMPILE_FAILED }}" == "true" ] || [ ! -d "$TARGET_DIR" ] || [ ! -f "$TARGET_DIR/"*.bin ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œç»ˆæ­¢å·¥ä½œæµ"
            exit 1
          fi

      - name: æ”¶é›†äº§ç‰©
        if: always()
        run: |
          set -e
          echo "ğŸ”„ æ”¶é›†äº§ç‰©..."
          ARTIFACT_DIR="${{ env.REPO_SHORT }}-${{ matrix.config_type }}"
          FIRMWARE_DIR="${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware"
          mkdir -p "$ARTIFACT_DIR"
          mkdir -p "$FIRMWARE_DIR"
          
          # ä¿®æ”¹åçš„TARGET_DIRï¼Œæ”¯æŒå¤šç§æ¶æ„
          TARGET_DIR="openwrt/bin/targets/${{ env.CHIP }}"
          
          # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$TARGET_DIR" ]; then
            echo "âŒ ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR"
            echo "é”™è¯¯: ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR" >> logs/error.log
            # åˆ›å»ºä¸€ä¸ªè¯´æ˜æ–‡ä»¶ï¼Œé¿å…ä¸Šä¼ é”™è¯¯
            echo "ç›®æ ‡ç›®å½•ä¸å­˜åœ¨: $TARGET_DIR" > "$FIRMWARE_DIR/target-directory-not-found.txt"
            echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼Œä½†ç›®æ ‡ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶æ–‡ä»¶
          FIRMWARE_COUNT=0
          for file in "$TARGET_DIR"/*.bin; do
            if [ -f "$file" ] && [[ "$file" == *"-squashfs-"* ]]; then
              FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
              
              # ä»æ–‡ä»¶åæå–è®¾å¤‡åç§°
              DEVICE_NAME_FROM_FILE=$(basename "$file" | sed -n 's/^.*-\(.*\)-squashfs-.*\.bin$/\1/p')
              
              if [ -z "$DEVICE_NAME_FROM_FILE" ]; then
                echo "è­¦å‘Šï¼šæ— æ³•ä»æ–‡ä»¶åä¸­æå–è®¾å¤‡åç§°: $(basename "$file")" >> logs/error.log
                continue
              fi
              
              # ç¡®å®šå›ºä»¶ç±»å‹
              if [[ "$file" == *"factory"* ]]; then
                FIRMWARE_TYPE="factory"
              elif [[ "$file" == *"sysupgrade"* ]]; then
                FIRMWARE_TYPE="sysupgrade"
              else
                continue
              fi
              
              NEW_NAME="${{ env.REPO_SHORT }}-${DEVICE_NAME_FROM_FILE}-${FIRMWARE_TYPE}-${{ matrix.config_type }}.bin"
              cp "$file" "$FIRMWARE_DIR/$NEW_NAME"
            fi
          done
          
          if [ "$FIRMWARE_COUNT" -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç¬¦åˆæ¡ä»¶çš„å›ºä»¶æ–‡ä»¶ï¼ˆåŒ…å«-squashfs-çš„.binæ–‡ä»¶ï¼‰"
            echo "è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç¬¦åˆæ¡ä»¶çš„å›ºä»¶æ–‡ä»¶ï¼ˆåŒ…å«-squashfs-çš„.binæ–‡ä»¶ï¼‰" >> logs/error.log
            # åˆ›å»ºä¸€ä¸ªè¯´æ˜æ–‡ä»¶ï¼Œé¿å…ä¸Šä¼ é”™è¯¯
            echo "æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å›ºä»¶æ–‡ä»¶ï¼ˆåŒ…å«-squashfs-çš„.binæ–‡ä»¶ï¼‰" > "$FIRMWARE_DIR/no-firmware-found.txt"
            echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼Œä½†æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å›ºä»¶æ–‡ä»¶"
            exit 1
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp temp_config/.config "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.config"
          
          # å¤åˆ¶å…¶ä»–æ–‡ä»¶
          if [ -f "openwrt/.config.buildinfo" ]; then
            cp openwrt/.config.buildinfo "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.config.buildinfo"
          fi
          
          if [ -f "$TARGET_DIR"/*.manifest ]; then
            cp "$TARGET_DIR"/*.manifest "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.manifest"
          fi
          
          if [ -f "openwrt/build.log" ]; then
            cp openwrt/build.log "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}-build.log"
          fi
          
          if [ -d "openwrt/bin/packages" ]; then
            mkdir -p "$ARTIFACT_DIR/packages"
            cp -r openwrt/bin/packages/* "$ARTIFACT_DIR/packages/"
          fi
          
          if [ -f logs/error.log ] && [ -s logs/error.log ]; then
            cp logs/error.log "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}-error.log"
          fi
          
          if [ -f logs/summary.log ] && [ -s logs/summary.log ]; then
            cp logs/summary.log "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}-summary.log"
          fi
          
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆï¼Œæ‰¾åˆ° $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
          
      - name: ä¸Šä¼ ç¼–è¯‘æ‘˜è¦
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary-${{ env.REPO_SHORT }}-${{ matrix.config_type }}
          path: |
            logs/summary.log
          retention-days: 30
          if-no-files-found: warn
          
      - name: ä¸Šä¼ é”™è¯¯æ—¥å¿—
        if: failure() || env.COMPILE_FAILED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ env.REPO_SHORT }}-${{ matrix.config_type }}
          path: |
            logs/error.log
          retention-days: 30
          if-no-files-found: warn
          
      - name: ä¸Šä¼ äº§ç‰©
        if: success() && env.COMPILE_FAILED != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}
          path: |
            ${{ env.REPO_SHORT }}-${{ matrix.config_type }}/
          retention-days: 7
          if-no-files-found: warn
          
      - name: ä¸Šä¼ å›ºä»¶
        if: success() && env.COMPILE_FAILED != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware
          path: |
            ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware/
          retention-days: 7
          if-no-files-found: error

  # æ‰“åŒ…å¹¶å‘å¸ƒRelease
  package-and-release:
    needs: build
    runs-on: ubuntu-22.04
    if: success() && !contains(needs.build.result, 'failure')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/
          
      - name: å‡†å¤‡å‘å¸ƒç›®å½•
        run: |
          set -e
          echo "ğŸ”„ å‡†å¤‡å‘å¸ƒç›®å½•..."
          mkdir -p release/{config,log,app,firmware,assets}
          
          # æ”¶é›†é…ç½®æ–‡ä»¶
          find all-artifacts -name "*.config" -exec cp {} release/config/ \;
          find all-artifacts -name "*.config.buildinfo" -exec cp {} release/config/ \;
          find all-artifacts -name "*.manifest" -exec cp {} release/config/ \;
          
          # æ”¶é›†æ—¥å¿—æ–‡ä»¶
          find all-artifacts -name "*-build.log" -exec cp {} release/log/ \;
          find all-artifacts -name "*-error.log" -exec cp {} release/log/ \;
          find all-artifacts -name "*-summary.log" -exec cp {} release/log/ \;
          
          # æ”¶é›†è½¯ä»¶åŒ…
          find all-artifacts -name "packages" -type d -exec cp -r {} release/app/ \;
          
          # æ”¶é›†å›ºä»¶æ–‡ä»¶
          FIRMWARE_COUNT=$(find all-artifacts -name "*.bin" | wc -l)
          find all-artifacts -name "*.bin" -exec cp {} release/firmware/ \;
          
          # æ‰“åŒ…æ–‡ä»¶
          tar -czf release/${{ env.CHIP }}-config.tar.gz -C release/config .
          tar -czf release/${{ env.CHIP }}-log.tar.gz -C release/log .
          tar -czf release/${{ env.CHIP }}-app.tar.gz -C release/app .
          
          # å¤åˆ¶åˆ°assetsç›®å½•
          cp release/${{ env.CHIP }}-config.tar.gz release/assets/
          cp release/${{ env.CHIP }}-log.tar.gz release/assets/
          cp release/${{ env.CHIP }}-app.tar.gz release/assets/
          cp release/firmware/*.bin release/assets/ 2>/dev/null || true
          
          # æå–ä¿¡æ¯
          KERNEL_VERSION=""
          LUCI_APPS=""
          DEVICE_LIST=""
          
          for config_file in release/config/*.config; do
            KERNEL_VER=$(grep "^CONFIG_LINUX_KERNEL_VERSION=" "$config_file" | cut -d'"' -f2)
            if [ -n "$KERNEL_VER" ]; then
              KERNEL_VERSION="$KERNEL_VER"
              break
            fi
          done
          
          if [ -d release/app ]; then
            LUCI_APPS=$(find release/app -name "luci-app-*.ipk" | sed 's/.*\///g' | sort | uniq | tr '\n' ' ')
          fi
          
          if [ -d release/firmware ]; then
            DEVICE_LIST=$(ls release/firmware/*.bin | sed -n 's/.*-\([^-]*\)-.*\.bin/\1/p' | sort | uniq | tr '\n' ' ')
          fi
          
          echo "KERNEL_VERSION=${KERNEL_VERSION}" >> $GITHUB_ENV
          echo "LUCI_APPS=${LUCI_APPS}" >> $GITHUB_ENV
          echo "DEVICE_LIST=${DEVICE_LIST}" >> $GITHUB_ENV
          echo "RELEASE_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          
          # åˆ›å»ºç”¨æˆ·å‹å¥½çš„READMEæ–‡ä»¶
          cat > release/README.md << EOF
          # ${{ env.CHIP }} å›ºä»¶å‘å¸ƒè¯´æ˜
          
          ## åŸºæœ¬ä¿¡æ¯
          - å‘å¸ƒæ—¥æœŸ: ${{ env.RELEASE_DATE }}
          - å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
          - æ”¯æŒè®¾å¤‡: ${{ env.DEVICE_LIST }}
          
          ## é»˜è®¤è®¾ç½®
          - ç®¡ç†åœ°å€: ${{ env.DEFAULT_IP }}
          - ç”¨æˆ·å: ${{ env.DEFAULT_USER }}
          - å¯†ç : ${{ env.DEFAULT_PASS }}
          - WiFiå¯†ç : ${{ env.DEFAULT_WIFI }}
          
          ## ä¸‹è½½è¯´æ˜
          ### å›ºä»¶æ–‡ä»¶
          å›ºä»¶æ–‡ä»¶å‘½åè§„åˆ™: [ä»“åº“ç®€ç§°]-[è®¾å¤‡åç§°]-[å›ºä»¶ç±»å‹]-[é…ç½®ç±»å‹].bin
          
          ä¾‹å¦‚:
          - imm-device1-factory-Ultra.bin (é€‚ç”¨äºè®¾å¤‡1çš„å·¥å‚å›ºä»¶)
          - imm-device1-sysupgrade-Ultra.bin (é€‚ç”¨äºè®¾å¤‡1çš„å‡çº§å›ºä»¶)
          
          è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡å‹å·é€‰æ‹©å¯¹åº”çš„å›ºä»¶æ–‡ä»¶ã€‚
          
          ### å…¶ä»–æ–‡ä»¶
          - ${{ env.CHIP }}-config.tar.gz: é…ç½®æ–‡ä»¶
          - ${{ env.CHIP }}-log.tar.gz: ç¼–è¯‘æ—¥å¿—
          - ${{ env.CHIP }}-app.tar.gz: è½¯ä»¶åŒ…
          
          ## å®‰è£…è¯´æ˜
          1. ä¸‹è½½é€‚ç”¨äºæ‚¨è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
          2. é€šè¿‡è®¾å¤‡ç®¡ç†ç•Œé¢æˆ–TFTPæ–¹å¼åˆ·å…¥å›ºä»¶
          3. åˆ·å…¥åä½¿ç”¨é»˜è®¤è®¾ç½®ç™»å½•è®¾å¤‡
          
          ## æ³¨æ„äº‹é¡¹
          - åˆ·å…¥å›ºä»¶å‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          - ç¡®ä¿ä¸‹è½½ä¸æ‚¨çš„è®¾å¤‡å‹å·å®Œå…¨åŒ¹é…çš„å›ºä»¶
          - åˆ·å…¥è¿‡ç¨‹ä¸­è¯·å‹¿æ–­ç”µ
          
          ## æŠ€æœ¯æ”¯æŒ
          å¦‚é‡é—®é¢˜ï¼Œè¯·å‚è€ƒç¼–è¯‘æ—¥å¿—æˆ–è”ç³»ä½œè€…: ${{ env.AUTHOR }}
          EOF
          
          # åˆ›å»ºRelease bodyæ–‡ä»¶
          cat > release/body.md << EOF
          é»˜è®¤ç®¡ç†åœ°å€ï¼š${{ env.DEFAULT_IP }}
          é»˜è®¤ç”¨æˆ·ï¼š${{ env.DEFAULT_USER }}
          é»˜è®¤å¯†ç ï¼š${{ env.DEFAULT_PASS }}
          é»˜è®¤WIFIå¯†ç : ${{ env.DEFAULT_WIFI }}
          
          å›ºä»¶åŒ…æ‹¬ï¼ˆ${{ env.CHIP }}ï¼‰çš„è®¾å¤‡ï¼š${{ env.DEVICE_LIST }}
          
          å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š${{ env.KERNEL_VERSION }}
          ä½œè€…: ${{ env.AUTHOR }}
          å‘å¸ƒæ—¶é—´: ${{ env.RELEASE_DATE }}
          ç¼–è¯‘çš„luci-appåˆ—è¡¨ï¼š${{ env.LUCI_APPS }}
          
          ## ä¸‹è½½è¯´æ˜
          - å›ºä»¶æ–‡ä»¶ï¼šè¯·ä»ä¸‹é¢çš„é™„ä»¶ä¸­ä¸‹è½½å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
          - é…ç½®æ–‡ä»¶ï¼š${{ env.CHIP }}-config.tar.gz
          - ç¼–è¯‘æ—¥å¿—ï¼š${{ env.CHIP }}-log.tar.gz
          - è½¯ä»¶åŒ…ï¼š${{ env.CHIP }}-app.tar.gz
          - ç”¨æˆ·æ‰‹å†Œï¼šREADME.md
          EOF
          
          echo "âœ… å‘å¸ƒç›®å½•å‡†å¤‡å®Œæˆï¼Œæ‰¾åˆ° $FIRMWARE_COUNT ä¸ªå›ºä»¶æ–‡ä»¶"
          
      - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_DATE }}-${{ env.CHIP }}
          name: ${{ env.CHIP }} Release ${{ env.RELEASE_DATE }}
          body_path: release/body.md
          files: |
            release/assets/*
            release/README.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
