name: IPQ-LAI

on:
  schedule:
    # åŒ—äº¬æ—¶é—´å‘¨äº”0ç‚¹ = UTCæ—¶é—´å‘¨å››16:00
    - cron: '0 16 * * 4'
  workflow_dispatch:

permissions:
  contents: write

env:
  # èŠ¯ç‰‡å˜é‡ï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰
  CHIP: ipq60xx
  
  # é»˜è®¤ä¿¡æ¯
  DEFAULT_IP: 192.168.111.1
  DEFAULT_USER: root
  DEFAULT_PASS: none
  DEFAULT_WIFI: 12345678
  AUTHOR: Mary

jobs:
  # æ„å»ºæ‰€æœ‰é…ç½®
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # é…ç½®ç±»å‹åœ¨å‰ï¼Œä»“åº“åœ¨å
        config_type: [Ultra, Max, Pro]
        repo: 
          - imm|${{ github.server_url }}/laipeng668/immortalwrt.git|master|immwrt
          - open|${{ github.server_url }}/laipeng668/openwrt.git|master|openwrt
          - lib|${{ github.server_url }}/laipeng668/openwrt-6.x.git|k6.12-nss|libwrt
      max-parallel: 3
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        run: |
          set -e
          echo "ğŸ”§ åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ..."
          
          # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
          mkdir -p logs
          
          # åˆ›å»ºç”¨æˆ·å‹å¥½æ‘˜è¦æ—¥å¿—
          echo "=== IPQ60xx å›ºä»¶ç¼–è¯‘æ‘˜è¦ ===" > logs/summary.log
          echo "å¼€å§‹æ—¶é—´: $(date)" >> logs/summary.log
          echo "é…ç½®ç±»å‹: ${{ matrix.config_type }}" >> logs/summary.log
          echo "ä»“åº“: ${{ matrix.repo }}" >> logs/summary.log
          echo "" >> logs/summary.log
          
          # åˆ›å»ºè¯¦ç»†æŠ€æœ¯æ—¥å¿—
          echo "=== è¯¦ç»†æŠ€æœ¯æ—¥å¿— ===" > logs/technical.log
          echo "å¼€å§‹æ—¶é—´: $(date)" >> logs/technical.log
          
          # åˆ›å»ºç¼–è¯‘è¿›åº¦æ—¥å¿—
          echo "=== ç¼–è¯‘è¿›åº¦ ===" > logs/progress.log
          
          echo "âœ… æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"
          
      - name: è®¾ç½®ä»“åº“ç¯å¢ƒå˜é‡
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ è®¾ç½®ä»“åº“ç¯å¢ƒå˜é‡..." | tee -a logs/summary.log
          
          IFS='|' read -r REPO_KEY REPO_URL REPO_BRANCH REPO_SHORT <<< "${{ matrix.repo }}"
          echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
          echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
          echo "REPO_SHORT=${REPO_SHORT}" >> $GITHUB_ENV
          echo "CONFIG_TYPE=${{ matrix.config_type }}" >> $GITHUB_ENV
          
          echo "ä»“åº“ä¿¡æ¯: $REPO_SHORT ($REPO_BRANCH)" >> logs/technical.log
          echo "âœ… ä»“åº“ä¿¡æ¯: $REPO_SHORT ($REPO_BRANCH)" | tee -a logs/summary.log
          echo "" >> logs/summary.log
          
      - name: æ¸…ç†å·¥ä½œç›®å½•
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ æ¸…ç†å·¥ä½œç›®å½•..." | tee -a logs/summary.log
          
          # å¼ºåˆ¶åˆ é™¤ç›®å½•
          echo "åˆ é™¤ openwrt ç›®å½•..." >> logs/technical.log
          rm -rf openwrt
          
          echo "åˆ é™¤ temp_config ç›®å½•..." >> logs/technical.log
          rm -rf temp_config
          
          # éªŒè¯ç›®å½•å·²åˆ é™¤
          if [ -d "openwrt" ]; then
            echo "âŒ é”™è¯¯: openwrt ç›®å½•ä»ç„¶å­˜åœ¨" | tee -a logs/summary.log
            exit 1
          fi
          
          if [ -d "temp_config" ]; then
            echo "âŒ é”™è¯¯: temp_config ç›®å½•ä»ç„¶å­˜åœ¨" | tee -a logs/summary.log
            exit 1
          fi
          
          echo "âœ… å·¥ä½œç›®å½•å·²æ¸…ç†" | tee -a logs/summary.log
          echo "" >> logs/summary.log
          
      # ç¼“å­˜æ­¥éª¤
      - name: ç¼“å­˜feedsç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/feeds
          key: feeds-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            feeds-
          
      - name: ç¼“å­˜ä¸‹è½½ç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            dl-
            
      - name: ç¼“å­˜ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ github.run_id }}
          restore-keys: |
            ccache-
            
      - name: ç¼“å­˜å·¥å…·é“¾ç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/build_dir/toolchain-*
          key: toolchain-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            toolchain-
            
      - name: ç¼“å­˜stagingç›®å½•
        uses: actions/cache@v4
        with:
          path: openwrt/staging_dir
          key: staging-${{ hashFiles('configs/${{ env.CHIP }}_base.config', 'configs/${{ env.REPO_SHORT }}_base.config') }}
          restore-keys: |
            staging-
          
      - name: åˆå¹¶é…ç½®æ–‡ä»¶
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ åˆå¹¶é…ç½®æ–‡ä»¶..." | tee -a logs/summary.log
          
          mkdir -p temp_config
          cat configs/${{ env.CHIP }}_base.config > temp_config/.config
          cat configs/${{ env.REPO_SHORT }}_base.config >> temp_config/.config
          cat configs/${{ matrix.config_type }}.config >> temp_config/.config
          
          if [ ! -s temp_config/.config ]; then
            echo "âŒ é”™è¯¯ï¼šé…ç½®æ–‡ä»¶åˆå¹¶å¤±è´¥" | tee -a logs/summary.log
            exit 1
          fi
          
          # æå–è®¾å¤‡ä¿¡æ¯
          DEVICE_LINES=$(grep '^CONFIG_TARGET_DEVICE_.*=y$' temp_config/.config)
          DEVICE_NAMES=""
          for line in $DEVICE_LINES; do
            DEVICE_NAME=$(echo "$line" | sed -n 's/^CONFIG_TARGET_DEVICE_[^_]*_[^_]*_DEVICE_\([^=]*\)=y/\1/p')
            if [ -n "$DEVICE_NAME" ]; then
              DEVICE_NAMES="$DEVICE_NAMES $DEVICE_NAME"
            fi
          done
          
          echo "DEVICE_NAMES=${DEVICE_NAMES}" >> $GITHUB_ENV
          echo "âœ… é…ç½®æ–‡ä»¶åˆå¹¶æˆåŠŸï¼Œç›®æ ‡è®¾å¤‡: $DEVICE_NAMES" | tee -a logs/summary.log
          echo "" >> logs/summary.log
          
      - name: å…‹éš†æºç 
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ å…‹éš†æºç ..." | tee -a logs/summary.log
          echo "ä»“åº“: ${{ env.REPO_URL }}" >> logs/technical.log
          echo "åˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> logs/technical.log
          
          # æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„openwrtç›®å½•
          if [ -d "openwrt" ]; then
            echo "å‘ç°å·²å­˜åœ¨çš„openwrtç›®å½•ï¼Œæ­£åœ¨åˆ é™¤..." >> logs/technical.log
            rm -rf openwrt
            if [ -d "openwrt" ]; then
              echo "âŒ é”™è¯¯: æ— æ³•åˆ é™¤openwrtç›®å½•" | tee -a logs/summary.log
              exit 1
            fi
          fi
          
          # å…‹éš†æºç 
          echo "å¼€å§‹å…‹éš†æºç ..." >> logs/technical.log
          git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt 2>&1 | tee -a logs/technical.log
          
          # éªŒè¯å…‹éš†ç»“æœ
          if [ ! -d "openwrt" ]; then
            echo "âŒ é”™è¯¯ï¼šå…‹éš†æºç å¤±è´¥ - openwrtç›®å½•ä¸å­˜åœ¨" | tee -a logs/summary.log
            exit 1
          fi
          
          cd openwrt
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "âœ… æºç å…‹éš†æˆåŠŸï¼Œæäº¤: ${COMMIT_HASH:0:7}" | tee -a logs/summary.log
          echo "" >> logs/summary.log
          cd ..
          
      - name: æ›´æ–°feeds
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ æ›´æ–°feeds..." | tee -a logs/summary.log
          cd openwrt
          
          echo "=== Feedsæ›´æ–°å¼€å§‹ ===" >> ../logs/technical.log
          ./scripts/feeds update -a 2>&1 | tee -a ../logs/technical.log
          ./scripts/feeds install -a 2>&1 | tee -a ../logs/technical.log
          echo "=== Feedsæ›´æ–°å®Œæˆ ===" >> ../logs/technical.log
          
          echo "âœ… Feedsæ›´æ–°å®Œæˆ" | tee -a ../logs/summary.log
          echo "" >> logs/summary.log
          
      - name: å®‰è£…ä¾èµ–
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ å®‰è£…ç¼–è¯‘ä¾èµ–..." | tee -a logs/summary.log
          cd openwrt
          
          echo "=== ä¾èµ–å®‰è£…å¼€å§‹ ===" >> ../logs/technical.log
          sudo apt-get update 2>&1 | tee -a ../logs/technical.log
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils python3-setuptools rsync unzip zlib1g-dev file wget 2>&1 | tee -a ../logs/technical.log
          echo "=== ä¾èµ–å®‰è£…å®Œæˆ ===" >> ../logs/technical.log
          
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ" | tee -a ../logs/summary.log
          echo "" >> logs/summary.log
          
      - name: ç¼–è¯‘å›ºä»¶
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          touch logs/progress.log
          
          echo "ğŸ”„ å¼€å§‹ç¼–è¯‘å›ºä»¶..." | tee -a logs/summary.log
          cd openwrt
          
          # åº”ç”¨é…ç½®
          cp ../temp_config/.config .config
          make defconfig 2>&1 | tee -a ../logs/technical.log
          
          # å¯ç”¨ccache
          export CCACHE_DIR=~/.ccache
          export USE_CCACHE=1
          export CCACHE_COMPRESS=1
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          echo "ç£ç›˜ç©ºé—´:" >> ../logs/technical.log
          df -h >> ../logs/technical.log
          
          # ç¼–è¯‘å¹¶è¿‡æ»¤è¾“å‡º
          echo "=== ç¼–è¯‘å¼€å§‹ ===" >> ../logs/technical.log
          make -j$(nproc) V=s 2>&1 | {
            while IFS= read -r line; do
              # è®°å½•æ‰€æœ‰è¾“å‡ºåˆ°æŠ€æœ¯æ—¥å¿—
              echo "$line" >> ../logs/technical.log
              
              # æå–å…³é”®ä¿¡æ¯åˆ°è¿›åº¦æ—¥å¿—
              if echo "$line" | grep -E "(CC|CXX|LD|AR|INSTALL|Building|Compiling|make\[.*\]:)"; then
                echo "$(date '+%H:%M:%S') - $line" >> ../logs/progress.log
              fi
              
              # æ£€æŸ¥é”™è¯¯
              if echo "$line" | grep -i "error\|failed\|undefined\|cannot"; then
                echo "âŒ é”™è¯¯: $line" | tee -a ../logs/summary.log
              fi
            done
          }
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "âŒ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..." | tee -a ../logs/summary.log
            make -j1 V=sc 2>&1 | tee -a ../logs/technical.log
            
            if [ $? -ne 0 ]; then
              echo "âŒ ç¼–è¯‘å¤±è´¥" | tee -a ../logs/summary.log
              
              # æå–å…³é”®é”™è¯¯ä¿¡æ¯
              echo "" >> logs/summary.log
              echo "=== é”™è¯¯æ‘˜è¦ ===" >> logs/summary.log
              tail -n 100 ../logs/technical.log | grep -i "error\|failed\|undefined\|cannot" | tail -n 10 >> logs/summary.log
              echo "===============" >> logs/summary.log
              
              exit 1
            fi
          fi
          
          echo "âœ… ç¼–è¯‘æˆåŠŸ" | tee -a ../logs/summary.log
          echo "" >> logs/summary.log
          
      - name: ä¸Šä¼ è¿›åº¦æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-progress
          path: |
            logs/progress.log
          retention-days: 3
          if-no-files-found: warn
          
      - name: æ”¶é›†äº§ç‰©
        if: always()
        run: |
          set -e
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
          mkdir -p logs
          touch logs/summary.log
          touch logs/technical.log
          
          echo "ğŸ”„ æ”¶é›†æ„å»ºäº§ç‰©..." | tee -a logs/summary.log
          
          ARTIFACT_DIR="${{ env.REPO_SHORT }}-${{ matrix.config_type }}"
          FIRMWARE_DIR="${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware"
          mkdir -p "$ARTIFACT_DIR"
          mkdir -p "$FIRMWARE_DIR"
          
          TARGET_DIR="openwrt/bin/targets/${{ env.CHIP }}"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp temp_config/.config "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.config"
          
          # å¤åˆ¶å…¶ä»–æ–‡ä»¶
          if [ -f "openwrt/.config.buildinfo" ]; then
            cp openwrt/.config.buildinfo "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.config.buildinfo"
          fi
          
          if [ -d "$TARGET_DIR" ] && [ -f "$TARGET_DIR"/*.manifest ]; then
            cp "$TARGET_DIR"/*.manifest "$ARTIFACT_DIR/${{ env.REPO_SHORT }}-${{ matrix.config_type }}.manifest"
          fi
          
          # å¤„ç†å›ºä»¶æ–‡ä»¶
          if [ -d "$TARGET_DIR" ]; then
            FOUND_FIRMWARE=0
            for file in "$TARGET_DIR"/*.bin; do
              if [ -f "$file" ] && [[ "$file" == *"-squashfs-"* ]]; then
                FOUND_FIRMWARE=1
                DEVICE_NAME_FROM_FILE=$(basename "$file" | sed -n 's/^.*-\(.*\)-squashfs-.*\.bin$/\1/p')
                
                if [ -n "$DEVICE_NAME_FROM_FILE" ]; then
                  if [[ "$file" == *"factory"* ]]; then
                    FIRMWARE_TYPE="factory"
                  elif [[ "$file" == *"sysupgrade"* ]]; then
                    FIRMWARE_TYPE="sysupgrade"
                  else
                    continue
                  fi
                  
                  NEW_NAME="${{ env.REPO_SHORT }}-${DEVICE_NAME_FROM_FILE}-${FIRMWARE_TYPE}-${{ matrix.config_type }}.bin"
                  cp "$file" "$FIRMWARE_DIR/$NEW_NAME"
                  echo "  - $DEVICE_NAME_FROM_FILE ($FIRMWARE_TYPE)" >> logs/summary.log
                fi
              fi
            done
            
            if [ "$FOUND_FIRMWARE" -eq 0 ]; then
              echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å›ºä»¶" | tee -a logs/summary.log
            else
              echo "âœ… æˆåŠŸå¤„ç† $FOUND_FIRMWARE ä¸ªå›ºä»¶æ–‡ä»¶" | tee -a logs/summary.log
            fi
          fi
          
          # å¤åˆ¶æ—¥å¿—æ–‡ä»¶
          cp logs/summary.log "$ARTIFACT_DIR/summary.log"
          cp logs/technical.log "$ARTIFACT_DIR/technical.log"
          
          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ" | tee -a logs/summary.log
          echo "" >> logs/summary.log
          
      - name: ä¸Šä¼ äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}
          path: |
            ${{ env.REPO_SHORT }}-${{ matrix.config_type }}/
          retention-days: 7
          if-no-files-found: warn
          
      - name: ä¸Šä¼ å›ºä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware
          path: |
            ${{ env.REPO_SHORT }}-${{ matrix.config_type }}-firmware/
          retention-days: 7
          if-no-files-found: warn

  # æ‰“åŒ…å¹¶å‘å¸ƒRelease
  package-and-release:
    needs: build
    runs-on: ubuntu-22.04
    if: always()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/
          
      - name: å‡†å¤‡å‘å¸ƒç›®å½•
        run: |
          set -e
          mkdir -p release/{config,log,firmware,assets}
          
          # æ”¶é›†é…ç½®æ–‡ä»¶
          find all-artifacts -name "*.config" -exec cp {} release/config/ \;
          find all-artifacts -name "*.config.buildinfo" -exec cp {} release/config/ \;
          find all-artifacts -name "*.manifest" -exec cp {} release/config/ \;
          
          # æ”¶é›†æ—¥å¿—æ–‡ä»¶
          find all-artifacts -name "summary.log" -exec cp {} release/log/ \;
          find all-artifacts -name "technical.log" -exec cp {} release/log/ \;
          
          # æ”¶é›†å›ºä»¶æ–‡ä»¶
          find all-artifacts -name "*.bin" -exec cp {} release/firmware/ \;
          
          # æå–ä¿¡æ¯
          KERNEL_VERSION=""
          DEVICE_LIST=""
          
          for config_file in release/config/*.config; do
            KERNEL_VER=$(grep "^CONFIG_LINUX_KERNEL_VERSION=" "$config_file" | cut -d'"' -f2)
            if [ -n "$KERNEL_VER" ]; then
              KERNEL_VERSION="$KERNEL_VER"
              break
            fi
          done
          
          if [ -d release/firmware ]; then
            DEVICE_LIST=$(ls release/firmware/*.bin | sed -n 's/.*-\([^-]*\)-.*\.bin/\1/p' | sort | uniq | tr '\n' ' ')
          fi
          
          # åˆ›å»ºç”¨æˆ·å‹å¥½çš„å‘å¸ƒè¯´æ˜
          cat > release/README.md << EOF
          # IPQ60xx å›ºä»¶å‘å¸ƒ
          
          ## åŸºæœ¬ä¿¡æ¯
          - **å‘å¸ƒæ—¥æœŸ**: $(date +%Y-%m-%d)
          - **å†…æ ¸ç‰ˆæœ¬**: $KERNEL_VERSION
          - **æ”¯æŒè®¾å¤‡**: $DEVICE_LIST
          - **ä½œè€…**: ${{ env.AUTHOR }}
          
          ## é»˜è®¤è®¾ç½®
          - **ç®¡ç†åœ°å€**: ${{ env.DEFAULT_IP }}
          - **ç”¨æˆ·å**: ${{ env.DEFAULT_USER }}
          - **å¯†ç **: ${{ env.DEFAULT_PASS }}
          - **WiFiå¯†ç **: ${{ env.DEFAULT_WIFI }}
          
          ## ä¸‹è½½è¯´æ˜
          1. ä»ä¸‹é¢çš„é™„ä»¶ä¸­ä¸‹è½½å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
          2. å›ºä»¶æ–‡ä»¶å‘½åè§„åˆ™: \`ä»“åº“-è®¾å¤‡-ç±»å‹-é…ç½®.bin\`
          3. æ”¯æŒçš„å›ºä»¶ç±»å‹:
             - \`factory\`: åˆ·æœºå›ºä»¶ï¼ˆé€‚ç”¨äºé¦–æ¬¡åˆ·æœºï¼‰
             - \`sysupgrade\`: å‡çº§å›ºä»¶ï¼ˆé€‚ç”¨äºç³»ç»Ÿå†…å‡çº§ï¼‰
          
          ## ä½¿ç”¨è¯´æ˜
          1. ç¡®ä¿é€‰æ‹©æ­£ç¡®çš„è®¾å¤‡å‹å·
          2. åˆ·æœºå‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          3. é¦–æ¬¡åˆ·æœºä½¿ç”¨ factory å›ºä»¶
          4. ç³»ç»Ÿå†…å‡çº§ä½¿ç”¨ sysupgrade å›ºä»¶
          
          ## æŠ€æœ¯ä¿¡æ¯
          - å®Œæ•´ç¼–è¯‘æ—¥å¿—: è¯·ä¸‹è½½ \`technical.log\` æ–‡ä»¶
          - ç¼–è¯‘æ‘˜è¦: è¯·ä¸‹è½½ \`summary.log\` æ–‡ä»¶
          
          ## æ³¨æ„äº‹é¡¹
          - åˆ·æœºæœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œ
          - å¦‚é‡é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æŠ€æœ¯æ—¥å¿—æ–‡ä»¶
          EOF
          
          # æ‰“åŒ…æ–‡ä»¶
          tar -czf release/${{ env.CHIP }}-config.tar.gz -C release/config .
          tar -czf release/${{ env.CHIP }}-log.tar.gz -C release/log .
          
          # å¤åˆ¶åˆ°assetsç›®å½•
          cp release/${{ env.CHIP }}-config.tar.gz release/assets/
          cp release/${{ env.CHIP }}-log.tar.gz release/assets/
          cp release/firmware/*.bin release/assets/ 2>/dev/null || true
          
      - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v1
        if: always()
        with:
          tag_name: $(date +%Y%m%d)-${{ env.CHIP }}
          name: ${{ env.CHIP }} Release $(date +%Y%m%d)
          body_path: release/README.md
          files: |
            release/assets/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
