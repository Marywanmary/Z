name: LibWrt Build All

on:
  schedule:
    - cron: '0 16 * * 4' # åŒ—äº¬æ—¶é—´å‘¨äº”0ç‚¹ (UTC+8 = UTC-8)
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'Ubuntuç‰ˆæœ¬'
        required: true
        default: 'ubuntu-22.04'
        type: choice
        options:
        - ubuntu-22.04
        - ubuntu-24.04

env:
  REPO_URL: https://github.com/laipeng668/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss
  REPO_SHORT: libwrt
  SOC_NAME: ipq60xx
  CONFIGS: '["Pro", "Max", "Ultra"]'

jobs:
  # æ„å»ºçŸ©é˜µç­–ç•¥
  build-matrix:
    runs-on: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}
    strategy:
      fail-fast: false
      matrix:
        config: [Pro, Max, Ultra]
    
    steps:
      - name: ğŸš€ å¼€å§‹æ„å»º
        run: |
          echo -e "\033[36mğŸš€ å¼€å§‹æ„å»º LibWrt - ${{ matrix.config }}\033[0m"
          echo -e "\033[36mğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\033[0m"
          echo -e "\033[36mğŸ”§ Ubuntuç‰ˆæœ¬: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}\033[0m"

  # è°ƒç”¨æ ¸å¿ƒæ„å»ºå·¥ä½œæµ
  build-pro:
    uses: ./.github/workflows/core-build.yml
    with:
      repo_url: ${{ env.REPO_URL }}
      repo_branch: ${{ env.REPO_BRANCH }}
      repo_short: ${{ env.REPO_SHORT }}
      soc_name: ${{ env.SOC_NAME }}
      config_profile: Pro
      ubuntu_version: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}
      manual_trigger: ${{ github.event_name == 'workflow_dispatch' }}

  build-max:
    uses: ./.github/workflows/core-build.yml
    with:
      repo_url: ${{ env.REPO_URL }}
      repo_branch: ${{ env.REPO_BRANCH }}
      repo_short: ${{ env.REPO_SHORT }}
      soc_name: ${{ env.SOC_NAME }}
      config_profile: Max
      ubuntu_version: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}
      manual_trigger: ${{ github.event_name == 'workflow_dispatch' }}

  build-ultra:
    uses: ./.github/workflows/core-build.yml
    with:
      repo_url: ${{ env.REPO_URL }}
      repo_branch: ${{ env.REPO_BRANCH }}
      repo_short: ${{ env.REPO_SHORT }}
      soc_name: ${{ env.SOC_NAME }}
      config_profile: Ultra
      ubuntu_version: ${{ github.event.inputs.ubuntu_version || 'ubuntu-22.04' }}
      manual_trigger: ${{ github.event_name == 'workflow_dispatch' }}

  # å‘å¸ƒé˜¶æ®µ
  release-pro:
    needs: build-pro
    uses: ./.github/workflows/core-release.yml
    with:
      repo_short: ${{ env.REPO_SHORT }}
      soc_name: ${{ env.SOC_NAME }}
      config_profile: Pro
      build_success: ${{ needs.build-pro.outputs.build_success }}
      kernel_version: ${{ needs.build-pro.outputs.kernel_version }}
      devices: ${{ needs.build-pro.outputs.devices }}
      luci_packages: ${{ needs.build-pro.outputs.luci_packages }}
      artifacts_hash: ${{ needs.build-pro.outputs.artifacts_hash }}
      manual_trigger: ${{ github.event_name == 'workflow_dispatch' }}

  release-max:
    needs: build-max
    uses: ./.github/workflows/core-release.yml
    with:
      repo_short: ${{ env.REPO_SHORT }}
      soc_name: ${{ env.SOC_NAME }}
      config_profile: Max
      build_success: ${{ needs.build-max.outputs.build_success }}
      kernel_version: ${{ needs.build-max.outputs.kernel_version }}
      devices: ${{ needs.build-max.outputs.devices }}
      luci_packages: ${{ needs.build-max.outputs.luci_packages }}
      artifacts_hash: ${{ needs.build-max.outputs.artifacts_hash }}
      manual_trigger: ${{ github.event_name == 'workflow_dispatch' }}

  release-ultra:
    needs: build-ultra
    uses: ./.github/workflows/core-release.yml
    with:
      repo_short: ${{ env.REPO_SHORT }}
      soc_name: ${{ env.SOC_NAME }}
      config_profile: Ultra
      build_success: ${{ needs.build-ultra.outputs.build_success }}
      kernel_version: ${{ needs.build-ultra.outputs.kernel_version }}
      devices: ${{ needs.build-ultra.outputs.devices }}
      luci_packages: ${{ needs.build-ultra.outputs.luci_packages }}
      artifacts_hash: ${{ needs.build-ultra.outputs.artifacts_hash }}
      manual_trigger: ${{ github.event_name == 'workflow_dispatch' }}

  # æ±‡æ€»ç»“æœ
  summary:
    needs: [build-pro, build-max, build-ultra]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š æ„å»ºæ±‡æ€»
        run: |
          echo -e "\033[36mğŸ“Š LibWrt æ„å»ºæ±‡æ€»\033[0m"
          echo -e "\033[36m===================\033[0m"
          echo -e "Proé…ç½®æ„å»ºçŠ¶æ€: ${{ needs.build-pro.result }}"
          echo -e "Maxé…ç½®æ„å»ºçŠ¶æ€: ${{ needs.build-max.result }}"
          echo -e "Ultraé…ç½®æ„å»ºçŠ¶æ€: ${{ needs.build-ultra.result }}"
          echo -e "\033[36m===================\033[0m"
          
          if [[ "${{ needs.build-pro.result }}" == "success" && "${{ needs.build-max.result }}" == "success" && "${{ needs.build-ultra.result }}" == "success" ]]; then
            echo -e "\033[32mâœ… æ‰€æœ‰é…ç½®æ„å»ºæˆåŠŸï¼\033[0m"
          else
            echo -e "\033[31mâŒ éƒ¨åˆ†é…ç½®æ„å»ºå¤±è´¥ï¼\033[0m"
            exit 1
          fi
